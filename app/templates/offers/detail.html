{% extends "base.html" %}
{% block content %}
  {% if not offer %}
    <div class="bg-white border rounded p-4">Offer not found.</div>
  {% else %}
    <div class="mb-4 flex items-center justify-between">
      <div>
        <h2 class="text-lg font-semibold">{{ offer.doc_name }}</h2>
        <div class="text-xs text-gray-500">Offer ID {{ offer.id }}</div>
      </div>
      <div class="flex items-center gap-4">
        <a href="/offers/{{ offer.id }}/export.xlsx" class="text-sm bg-blue-600 text-white px-3 py-1 rounded">Export to Excel</a>
        <a href="/offers" class="text-sm text-blue-600">Back to list</a>
      </div>
    </div>

    {% if offer.pdf_filename %}
      <section class="bg-white border rounded p-4 mb-6">
        <div class="font-medium mb-2">Source PDF</div>
        <div class="w-full h-[70vh]">
          <iframe src="/uploads/{{ offer.pdf_filename }}" class="w-full h-full border" title="Offer PDF"></iframe>
        </div>
        <div class="mt-2 text-xs"><a class="text-blue-600" href="/uploads/{{ offer.pdf_filename }}" target="_blank">Open PDF in new tab</a></div>
      </section>
    {% endif %}

    {% for section in detail %}
      <section class="bg-white border rounded p-4 mb-6">
        <div class="flex items-center justify-between mb-2">
          <div>
            <div class="font-medium">Group {{ section.group.group_nr or '-' }} — {{ section.group.title }}</div>
            <div class="text-xs text-gray-500">Pages {{ section.group.page_from }}–{{ section.group.page_to }}</div>
          </div>
        </div>

        {% set variants = section.variants %}
        {% set components = section.components %}
        {% set counts = section.counts %}

        {% if variants and components %}
          <div class="overflow-auto">
            <table class="min-w-full border text-sm">
              <thead>
                <tr class="bg-gray-50">
                  <th class="border px-2 py-1 text-left">Variant</th>
                  {% for c in components %}
                    <th class="border px-2 py-1 text-left" x-data="{open:false}">
                      <div x-show="!open" class="truncate max-w-[14rem]">{{ c.description }}</div>
                      <div x-show="open" class="whitespace-pre-wrap">{{ c.description }}</div>
                      <button type="button" class="text-[11px] text-blue-600 mt-1" @click="open=!open" x-text="open ? 'Less' : 'More'"></button>
                    </th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for v in variants %}
                  <tr>
                    <td class="border px-2 py-1" x-data="{open:false}">
                      <div class="font-medium whitespace-nowrap">{{ v.var_nr or '-' }} — {{ v.short_text }}</div>
                      {% if v.long_text %}
                        <div x-show="!open" class="text-xs text-gray-500">{{ v.long_text|truncate(120) }}</div>
                        <div x-show="open" class="text-xs text-gray-700 whitespace-pre-wrap">{{ v.long_text }}</div>
                        <button type="button" class="text-[11px] text-blue-600 mt-1" @click="open=!open" x-text="open ? 'Less' : 'More'"></button>
                      {% endif %}
                    </td>
                    {% for c in components %}
                      {% set k = (v.id, c.id) %}
                      <td class="border px-2 py-1 text-center">{{ counts.get(k) or 0 }}</td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
              <tfoot>
                <tr class="bg-gray-50 font-medium">
                  <td class="border px-2 py-1 text-right">Total</td>
                  {% for c in components %}
                    {% set ns = namespace(total=0) %}
                    {% for v in variants %}
                      {% set ns.total = ns.total + (counts.get((v.id, c.id)) or 0) %}
                    {% endfor %}
                    <td class="border px-2 py-1 text-center">{{ ns.total }}</td>
                  {% endfor %}
                </tr>
              </tfoot>
            </table>
          </div>
        {% else %}
          <div class="text-gray-600">No variants/components captured.</div>
        {% endif %}
      </section>
    {% endfor %}
  {% endif %}
{% endblock %}

